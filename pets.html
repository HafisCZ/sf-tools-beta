<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Pet Simulator</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="res/favicon.png"/>

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>
        <link rel="stylesheet" href="css/pets.css"/>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/html2canvas.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>
        <script src="js/lang.js"></script>

        <script src="js/core/util.js"></script>
        <script src="js/core/playa.js"></script>
        <script src="js/core/core.js"></script>
        <script src="js/plugins.js"></script>
        <script src="js/core/idb.js"></script>
        <script src="js/core/ast.js"></script>
        <script src="js/stats/settings.js"></script>
        <script src="endpoint/endpoint.js"></script>

        <script src="js/changelog.js"></script>
        <script src="js/sim/pets.js"></script>
        <script src="js/views.js"></script>

    </head>
    <body class="margin-none-bottom">
        <div class="statistics-module" id="stats-module">
            <div class="ui fluid basic gray button" id="load-stats"><i class="sync alternate icon"></i>Poll saved characters</div>
            <div id="stats-list">
                <!-- LIST -->
            </div>
        </div>

        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item"><a class="css-a-blank" href="index.html">SFTools</a></div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i><span class="css-small">Go back</span></a>
            </div>
        </div>

        <div class="ui main container">
            <!-- Header -->
            <div class="ui five columns middle aligned grid">
                <div class="five wide column">
                    <div class="ui checkbox" id="useArmor" style="float: right;"  data-position="bottom left" data-tooltip="Keep unchecked unless playing on new backend! Applies to: Beta, S31.DE, W55 and many more (check discord for full list)">
                        <input type="checkbox" name="useArmorCheckbox">
                        <label for="useArmorCheckbox">New backend</label>
                    </div>
                </div>
                <div class="one wide column">

                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Pet Simulator</h1>
                </div>
                <div class="two wide column" data-tooltip="Generate a level / gladiator success map. Only possible with own pet against a dungeon boss." data-position="left center">
                    <div class="ui simple dropdown" id="sim-generate">
                        Generate
                        <i class="dropdown icon"></i>
                        <div class="menu">
                            <div class="item" id="sim-generate1">Generate</div>
                            <div class="item" id="sim-generate5">Generate next 5</div>
                            <div class="item" id="sim-generate10">Generate next 10</div>
                        </div>
                    </div>
                </div>
                <div class="two wide column">
                    <button class="ui fluid small button" type="submit" id="sim-run">Run</button>
                </div>
                <div class="two wide wide column" id="sim-result">

                </div>
            </div>
            <div class="ui two columns grid">
                <!-- First -->
                <div class="column">
                    <div class="ui form" id="sim-a">
                        <div class="bordered bone">
                            <div class="three fields">
                                <div class="field">
                                    <label>Type</label>
                                    <div class="ui selection compact dropdown" data-path="Type">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Pet</label>
                                    <div class="ui search selection compact dropdown" data-path="Pet">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Habitat</label>
                                            <div class="ui selection compact dropdown" data-path="Habitat">
                                                <div class="text"></div>
                                                <i class="dropdown icon"></i>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <label>Level</label>
                                            <input class="text-center" data-path="Level">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Pack</label>
                                    <input class="text-center" data-path="Pack" placeholder="Pets you caught">
                                </div>
                                <div class="field">
                                    <label>At 100 - 199</label>
                                    <input class="text-center" data-path="At100" placeholder="Pets at 100 - 199">
                                </div>
                                <div class="field">
                                    <label>At 200</label>
                                    <input class="text-center" data-path="At200" placeholder="Pets at 200">
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Gladiator</label>
                                    <div class="ui search selection compact dropdown" data-path="Gladiator">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bordered bone" data-debug="">
                            <div class="two fields">
                                <div class="field">
                                    <label>Class</label>
                                    <input class="text-center" disabled data-dpath="Class">
                                </div>
                                <div class="field">
                                    <label>Health</label>
                                    <input class="text-center" disabled data-dpath="TotalHealth">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Attribute</label>
                                    <input class="text-center" disabled data-dpath="Attribute">
                                </div>
                                <div class="field">
                                    <label>Defense</label>
                                    <input class="text-center" disabled data-dpath="DefenseAttribute">
                                </div>
                                <div class="field">
                                    <label>Luck</label>
                                    <input class="text-center" disabled data-dpath="LuckAttribute">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Skip Chance</label>
                                    <input class="text-center" disabled data-dpath="SkipChance">
                                </div>
                                <div class="field">
                                    <label>Critical Chance</label>
                                    <input class="text-center" disabled data-dpath="CriticalChance">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Damage</label>
                                    <input class="text-center" disabled data-dpath="Damage">
                                </div>
                                <div class="field">
                                    <label>Critical</label>
                                    <input class="text-center" disabled data-dpath="Critical">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Player list -->
                <div class="column">
                    <div class="ui form" id="sim-b">
                        <div class="bordered btwo">
                            <div class="three fields">
                                <div class="field">
                                    <label>Type</label>
                                    <div class="ui selection compact dropdown" data-path="Type">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Pet</label>
                                    <div class="ui search selection compact dropdown" data-path="Pet">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Habitat</label>
                                            <div class="ui selection compact dropdown" data-path="Habitat">
                                                <div class="text"></div>
                                                <i class="dropdown icon"></i>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <label>Level</label>
                                            <input class="text-center" data-path="Level">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Pack</label>
                                    <input class="text-center" data-path="Pack" placeholder="Pets you caught">
                                </div>
                                <div class="field">
                                    <label>At 100 - 199</label>
                                    <input class="text-center" data-path="At100" placeholder="Pets at 100 - 199">
                                </div>
                                <div class="field">
                                    <label>At 200</label>
                                    <input class="text-center" data-path="At200" placeholder="Pets at 200">
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Gladiator</label>
                                    <div class="ui search selection compact dropdown" data-path="Gladiator">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bordered btwo" data-debug="">
                            <div class="two fields">
                                <div class="field">
                                    <label>Class</label>
                                    <input class="text-center" disabled data-dpath="Class">
                                </div>
                                <div class="field">
                                    <label>Health</label>
                                    <input class="text-center" disabled data-dpath="TotalHealth">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Attribute</label>
                                    <input class="text-center" disabled data-dpath="Attribute">
                                </div>
                                <div class="field">
                                    <label>Defense</label>
                                    <input class="text-center" disabled data-dpath="DefenseAttribute">
                                </div>
                                <div class="field">
                                    <label>Luck</label>
                                    <input class="text-center" disabled data-dpath="LuckAttribute">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Skip Chance</label>
                                    <input class="text-center" disabled data-dpath="SkipChance">
                                </div>
                                <div class="field">
                                    <label>Critical Chance</label>
                                    <input class="text-center" disabled data-dpath="CriticalChance">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Damage</label>
                                    <input class="text-center" disabled data-dpath="Damage">
                                </div>
                                <div class="field">
                                    <label>Critical</label>
                                    <input class="text-center" disabled data-dpath="Critical">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sim-maps">

            </div>
        </div>

        <div id="results-modal" class="ui tiny modal">
            <div class="header">Results</div>
            <div class="content">

            </div>
        </div>

        <script type="text/javascript">
            function clearMaps () {
                $('#sim-maps').html('');
            }

            function addMap (map, key) {
                var ml = map.reduce((col, a) => col + (a ? 1 : 0), 0);

                $('#sim-maps').append(`
                    <div class="map-parent">
                        <button data-key="${ key }" class="map-save ui small basic icon button" data-position="bottom center" data-tooltip="Save as image"><i class="download icon"></i></button>
                        <table data-key="${ key }" class="map-map ui celled structured table table-group table-map-pet fixed-header">
                            <thead>
                                <tr>
                                    <td colspan="17" class="text-center spanned">${ key }</td>
                                </tr>
                                <tr>
                                    ${ map.find(x => x && x.length).reduce((col, a, i) => col + `<td>Glad ${ i }</td>`, '<td>Level</td>') }
                                </tr>
                            </thead>
                            <tbody style="height: ${ (Math.min(2.3 * ml, 46)).toFixed(1) }em;" data-proper="${ (2.3 * ml).toFixed(1) }em">
                                ${ map.reduce((col, a, i) => col + `<tr><td>${ i + 1 }</td>${ a.reduce((c, w) => c + `<td class="${ getPetColor(w) }">${ w.toFixed(2) }%</td>`, '') }</tr>`, '') }
                            </tbody>
                        </table>
                    </div>
                `);

                $('#sim-maps').find(`button[data-key="${ key }"]`).click(() => {
                    html2canvas($(`table[data-key="${ key }"]`).get(0), {
                        logging: false,
                        onclone: (doc) => {
                            var $table = $(doc).find(`table[data-key="${ key }"]`);
                            var $body = $table.find('tbody');

                            $body.css('height', $body.attr('data-proper'));
                        }
                    }).then((canvas) => {
                        canvas.toBlob((blob) => {
                            window.download(`${ key }.png`, blob);
                        });
                    });
                });
            }

            function validateBulk ($parent) {
                return $parent.find('[data-path]').toArray().reduce((errors, element) => {
                    if (isNaN($(element).val())) {
                        $(element).parent('.field').addClass('error');
                        return errors + 1;
                    } else {
                        $(element).parent('.field').removeClass('error');
                        return errors;
                    }
                }, 0) == 0;
            }

            function validate ($element) {
                if (isNaN($element.val())) {
                    $element.parent('.field').addClass('error');
                    return false;
                } else {
                    $element.parent('.field').removeClass('error');
                    return true;
                }
            }

            function toggleAll (dis) {
                if (dis) {
                    PopupController.open(LoaderPopup);
                } else {
                    PopupController.close(LoaderPopup);
                }
            }

            const PET_TYPE_NAMES = [
                'Shadow',
                'Light',
                'Earth',
                'Fire',
                'Water'
            ];

            class PetController {
                constructor ($root, index) {
                    this.$root = $root;

                    // Variables
                    this.Gladiator = 0;
                    this.Pet = 0;
                    this.Type = 0;
                    this.Boss = 0;
                    this.Level = 0;
                    this.Pack = 0;
                    this.At100 = 0;
                    this.At200 = 0;
                    this.Index = index;

                    // Elements
                    this.$level = $root.find('[data-path="Level"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.Level = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    this.$pack = $root.find('[data-path="Pack"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.Pack = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    this.$at100 = $root.find('[data-path="At100"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.At100 = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    this.$at200 = $root.find('[data-path="At200"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.At200 = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    // Gladiator
                    this.$gladiator = $root.find('[data-path="Gladiator"]').dropdown({
                        values: [
                            { name: 'None', value: 0 },
                            ... [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ].map(gladiator => {
                                return {
                                    name: `${ gladiator } (${ gladiator * 5 }%)`,
                                    value: gladiator
                                }
                            })
                        ]
                    }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                        this.Gladiator = Number(value);

                        this.refresh();
                    });

                    // Habitat
                    this.$habitat = $root.find('[data-path="Habitat"]').dropdown({
                        values: [
                            { name: 'No', value: 0 },
                            { name: 'Yes', value: 1 }
                        ]
                    }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                        this.setHabitat(Number(value));

                        this.refresh();
                    });

                    // Pets
                    this.$pet = $root.find('[data-path="Pet"]').dropdown({
                        fullTextSearch: true,
                        preserveHTML: true,
                        values: new Array(100).fill(0).map((_ , i) => {
                            return {
                                name: `<img class="ui centered image pet-picture" src="res/pets/monster${ 800 + i }.png"><span class="pet-name" data-pet-id="${ (i % 20) + 1 }">${ NAME_MONSTER[800 + i] }</span>`,
                                value: i
                            };
                        })
                    }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                        this.Pet = Number(value) % 20;
                        this.refresh();
                    });

                    // Types
                    this.$type = $root.find('[data-path="Type"]').dropdown({
                        values: [
                            { name: 'Shadow', value: 0 },
                            { name: 'Light', value: 1 },
                            { name: 'Earth', value: 2 },
                            { name: 'Fire', value: 3 },
                            { name: 'Water', value: 4 }
                        ]
                    }).dropdown('setting', 'onChange', (value, text) => {
                        this.setType(Number(value));

                        this.refresh();
                    }).dropdown('set selected', '0');
                }

                setType (type) {
                    this.Type = type;
                    this.Pet = 0;

                    this.$pet.dropdown('set selected', (this.Type * 20).toString());
                    this.$pet.find('.item').each((i, e) => {
                        var $e = $(e);
                        var id = Number($e.attr('data-value'));

                        if (Math.trunc(id / 20) == type) {
                            $e.removeClass('css-hidden');
                        } else {
                            $e.addClass('css-hidden');
                        }
                    });
                }

                setHabitat (habitat) {
                    this.Boss = habitat;

                    if (habitat) {
                        this.$level.parent('.field').addClass('disabled');
                        this.$pack.parent('.field').addClass('disabled');
                        this.$at100.parent('.field').addClass('disabled');
                        this.$at200.parent('.field').addClass('disabled');
                        this.$gladiator.parent('.field').addClass('disabled');
                    } else {
                        this.$level.parent('.field').removeClass('disabled');
                        this.$pack.parent('.field').removeClass('disabled');
                        this.$at100.parent('.field').removeClass('disabled');
                        this.$at200.parent('.field').removeClass('disabled');
                        this.$gladiator.parent('.field').removeClass('disabled');
                    }
                }

                refresh () {
                    if (validateBulk(this.$root)) {
                        if (this.Level > 0 || this.Boss) {
                            models[this.Index] = PetModel.fromObject(this);
                            this.$root.find('[data-debug]').show();
                        } else {
                            models[this.Index] = undefined;
                            this.$root.find('[data-debug]').hide();
                        }
                    } else {
                        models[this.Index] = undefined;
                        this.$root.find('[data-debug]').hide();
                    }

                    refreshModels();
                }

                fillDebugInformation (model, initialized) {
                    this.$root.find('[data-dpath="Class"]').val(PLAYER_CLASS[model.Class]);
                    this.$root.find('[data-dpath="TotalHealth"]').val(formatAsSpacedNumber(model.TotalHealth, ' '));
                    this.$root.find('[data-dpath="Attribute"]').val(formatAsSpacedNumber(model.Attribute, ' '));
                    this.$root.find('[data-dpath="DefenseAttribute"]').val(formatAsSpacedNumber(model.DefenseAttribute, ' '));
                    this.$root.find('[data-dpath="LuckAttribute"]').val(formatAsSpacedNumber(model.LuckAttribute, ' '));

                    if (initialized) {
                        this.$root.find('[data-dpath="SkipChance"]').val(model.SkipChance > 0 ? `${ model.SkipChance.toFixed(2) }%` : 'None');
                        this.$root.find('[data-dpath="Damage"]').val(formatAsSpacedNumber(model.Damage, ' '));
                        this.$root.find('[data-dpath="CriticalChance"]').val(model.CriticalChance > 0 ? `${ model.CriticalChance.toFixed(2) }%` : 'None');
                        this.$root.find('[data-dpath="Critical"]').val(`${ Math.round(100 * model.Critical) }%`);
                    } else {
                        this.$root.find('[data-dpath="SkipChance"], [data-dpath="CriticalChance"], [data-dpath="Damage"], [data-dpath="Critical"]').val('?');
                    }
                }

                getData () {
                    return {
                        Gladiator: this.Gladiator,
                        Pet: this.Pet,
                        Type: this.Type,
                        Boss: this.Boss,
                        Level: this.Level,
                        Pack: this.Pack,
                        At100: this.At100,
                        At200: this.At200,
                        Index: this.Index
                    };
                }

                loadData (data) {
                    if (!data) return;

                    this.$at100.val(data.At100).trigger('input');
                    this.$at200.val(data.At200).trigger('input');
                    this.$pack.val(data.Pack).trigger('input');
                    this.$level.val(data.Level).trigger('input');

                    this.$gladiator.dropdown('set selected', data.Gladiator.toString());
                    this.$type.dropdown('set selected', data.Type.toString());
                    this.$pet.dropdown('set selected', (data.Type * 20 + data.Pet).toString());
                    this.$habitat.dropdown('set selected', data.Boss.toString());
                }
            };

            function refreshModels () {
                var [a, b] = models;
                var ab = false;

                if (a && b) {
                    a.initialize(b);
                    b.initialize(a);

                    ab = true;

                    petA.fillDebugInformation(a, true);
                    petB.fillDebugInformation(b, true);
                } else if (a) {
                    petA.fillDebugInformation(a, false);
                } else if (b) {
                    petB.fillDebugInformation(b, false);
                }

                if (petA && petB && petA.Boss == 0 && petB.Boss == 1) {
                    $('#sim-generate').removeClass('disabled');
                } else {
                    $('#sim-generate').addClass('disabled');
                }
            }

            var models = [ undefined, undefined ];

            var petA = new PetController($('#sim-a'), 0);
            var petB = new PetController($('#sim-b'), 1);

            var useArmor = false;
            var useArmorCheckbox = $('#useArmor').checkbox('uncheck').change((event) => {
                useArmor = $(event.currentTarget).checkbox('is checked');
            });

            $('#sim-run').click(function () {
                if (validateBulk(petA.$root) && validateBulk(petB.$root)) {
                    toggleAll(true);
                    simulateFight(petA.getData(), petB.getData()).then(([chance, a, b]) => {
                        $('#sim-result').html(chance.toFixed(chance < 0.01 ? 5 : 2) + '%');
                        toggleAll();
                    }).catch(() => {
                        toggleAll();
                    });
                }
            });

            function simulateFight (a, b) {
                return new Promise(async (resolve, reject) => {
                    if (a && b && (a.Level > 0 || a.Boss) && (b.Level > 0 || b.Boss)) {
                        let worker = await createPetWorker();

                        worker.addEventListener('message', (message) => {
                            if (message.data.command == 'finished') {
                                resolve([message.data.results, a, b]);
                            }
                        }, false);

                        worker.postMessage({
                            mode: SimulatorType.Pet,
                            players: [a, b],
                            useArmor: useArmor
                        });
                    } else {
                        reject();
                    }
                });
            }

            function getPetColor (num) {
                if (num < 0.01) {
                    return 'pet-0';
                } else if (num >= 25) {
                    return 'pet-25'
                } else if (num >= 10) {
                    return 'pet-10';
                } else if (num >= 5) {
                    return 'pet-5';
                } else {
                    return 'pet-1';
                }
            }

            async function generatePetMap (mapCount) {
                if (validateBulk(petA.$root) && validateBulk(petB.$root)) {
                    $('#sim-result').html('');
                    clearMaps();

                    var a = petA.getData();
                    var b = [];

                    var temp = petB.getData();

                    if (a && temp && !a.Boss && temp.Boss) {
                        toggleAll(true);

                        var count = 0;
                        for (var i = temp.Pet; i < Math.min(20, temp.Pet + mapCount); i++) {
                            var bs = petB.getData();
                            bs.Pet = i;
                            b.push(bs);

                            count++;
                        }

                        var maps = [];
                        var maps_finished = 0;

                        for (var i = 0; i < count; i++) {
                            var worker = await createPetWorker();

                            worker.addEventListener('message', function (message) {
                                if (message.data.command == 'finished') {
                                    maps[message.data.tracking] = message.data.results;
                                    maps_finished++;

                                    if (maps_finished == count) {
                                        toggleAll();

                                        for (var j = 0; j < maps.length; j++) {
                                            addMap(maps[j], `${ PET_TYPE_NAMES[a.Type] } ${ a.Pet + 1 } - ${ NAME_MONSTER[800 + a.Type * 20 + a.Pet] } (${ a.Pack }, ${ a.At100 }, ${ a.At200 }) vs ${ PET_TYPE_NAMES[b[j].Type] } ${ b[j].Pet + 1 } - ${ NAME_MONSTER[800 + b[j].Type * 20 + b[j].Pet] }`);
                                        }
                                    }
                                }
                            }, false);

                            worker.postMessage({
                                mode: SimulatorType.PetMap,
                                players: [a, b[i]],
                                tracking: i,
                                useArmor: useArmor
                            });
                        }
                    }
                }
            }

            $('#sim-generate1').click(() => generatePetMap(1));
            $('#sim-generate5').click(() => generatePetMap(5));
            $('#sim-generate10').click(() => generatePetMap(10));

            $('#load-stats').click(() => {
                toggleAll(true);
                DatabaseManager.load(SELF_PROFILE).then(function () {
                    $('#stats-list').empty();

                    for (let player of Object.keys(DatabaseManager.Players).map(pid => DatabaseManager.getPlayer(pid).Latest).sort((a, b) => b.Timestamp - a.Timestamp).filter(p => p.Pets && p.Pets.TotalLevel)) {
                        let hasDungeonsLeft = player.Pets.Dungeons.some(pet => pet < 20);

                        $('#stats-list').append($(`
                            <div class="ui fluid button basic vertical animated gray" style="margin-bottom: 0.5em;">
                                <div class="visible content">
                                    <span style="color: black;">${ player.Name } @ ${ player.Prefix }<span>
                                </div>
                                <div class="hidden content">
                                    <span style="color: black;">Level ${ player.Level } ${ PLAYER_CLASS[player.Class] }<span>
                                </div>
                                <div style="position: absolute; right: 0.25em; top: 32.5%; ${hasDungeonsLeft ? '' : 'display: none;'}" data-player-id="${ player.Identifier }">
                                    <i class="expand icon"></i>
                                </div>
                            </div>
                            `).click(() => {
                                let [playerPet, bossPet] = getPetsFor(player, petA.Type);
                                petA.loadData(playerPet);
                                petB.loadData(bossPet);
                            }
                        ));

                        $(`div[data-player-id="${ player.Identifier }"]`).click((event) => {
                            event.stopPropagation();
                            toggleAll(true);

                            let petFights = [];
                            let results = [];

                            for (let type = 0; type < 5; type++) {
                                let [pet1, pet2] = getPetsFor(player, type);
                                if (pet2) {
                                    petFights.push(simulateFight(pet1, pet2).then(([chance, a, b]) => {
                                        results.push({
                                            chance,
                                            player: a,
                                            boss: b
                                        });
                                    }));
                                }
                            }

                            Promise.all(petFights).then(() => {
                                toggleAll();
                                _sort_des(results, i => i.chance);

                                $('#results-modal .content').html(`
                                    <div class="ui three column grid">
                                        ${ results.map(({ chance, player, boss }) => {
                                            let playerIndex = 800 + 20 * player.Type + player.Pet;
                                            let bossIndex = 800 + 20 * boss.Type + boss.Pet;
                                            return `
                                                <div class="two wide column">
                                                    <img src="res/pets/monster${ playerIndex }.png" style="height: 3em;">
                                                </div>
                                                <div class="four wide column" style="line-height: 3em; font-size: 110%;">
                                                    ${ NAME_MONSTER[playerIndex] }
                                                </div>
                                                <div class="two wide column">
                                                    <img src="res/pets/monster${ bossIndex }.png" style="height: 3em;">
                                                </div>
                                                <div class="four wide column" style="line-height: 3em; font-size: 110%;">
                                                    ${ NAME_MONSTER[bossIndex] }
                                                </div>
                                                <div class="four wide column text-center" style="line-height: 3em;">
                                                    ${ chance == 0 ? 'Not possible' : `${ chance.toFixed(chance < 0.01 ? 5 : 2) }%` }
                                                </div>
                                            `;
                                        }).join('') }
                                    </div>
                                `);
                                $('#results-modal').modal('show');
                            });
                        });
                    }

                    $('#stats-list').append(
                        $('<div class="ui two basic tiny gray buttons"></div>').append(
                            $(`
                                <div class="ui fluid button vertical">
                                    <div class="visible content">
                                        <span style="color: gray;">Endpoint<span>
                                    </div>
                                </div>
                            `).click(() => {
                                Endpoint.start('endpoint/pets').then(() => {
                                    $('#load-stats').trigger('click');
                                });
                            }),
                            $(`
                                <label class="ui fluid button vertical" for="button-upload">
                                    <span style="color: gray;">HAR<span>
                                </label>
                                <input type="file" multiple data-op="upload" accept=".har,.json" class="css-hidden" id="button-upload">
                            `).change((fileEvent) => {
                                toggleAll(true);

                                let pendingPromises = [];
                                Array.from(fileEvent.target.files).forEach(file => pendingPromises.push(file.text().then(fileContent => DatabaseManager.import(fileContent, file.lastModified, undefined, 'har/pets'))));
                                Promise.all(pendingPromises).then(() => {
                                    $('#load-stats').trigger('click');
                                });
                            })
                        )
                    );

                    toggleAll();
                }).catch(function () {
                    toggleAll();
                    Logger.log('WARNING', 'Database could not be opened!');
                    $('#stats-list').empty();
                });
            });

            function getPetsFor (player, type) {
                let currentType = type;
                let currentName = [
                    'Shadow', 'Light', 'Earth', 'Fire', 'Water'
                ][currentType];

                let gladiator = _try(player.Fortress, 'Gladiator') || 0;
                let pack = player.Pets[`${currentName}Count`];
                let petLevels = player.Pets[`${currentName}Levels`];
                let at100 = _len_where(petLevels, l => _between(l, 99, 200));
                let at200 = _len_where(petLevels, l => l == 200);

                let pets = petLevels.map((level, i) => {
                    return {
                        Gladiator: gladiator,
                        Pet: i,
                        Type: currentType,
                        Boss: 0,
                        Level: level,
                        Pack: pack,
                        At100: at100,
                        At200: at200,
                        Index: 0
                    }
                });

                let bestPet = pets.filter(data => data.Level).map(data => PetModel.fromObject(data)).sort((a, b) => b.Attribute - a.Attribute)[0];

                let pet1 = pets[bestPet.Pet];
                let pet2 = null;

                let dungeonPet = player.Pets.Dungeons[currentType];
                if (dungeonPet < 20) {
                    pet2 = {
                        Gladiator: 0,
                        Pet: dungeonPet,
                        Type: currentType,
                        Boss: 1,
                        Level: 0,
                        Pack: 0,
                        At100: 0,
                        At200: 0,
                        Index: 1
                    };
                }

                return [pet1, pet2];
            }
        </script>
    </body>
</html>
