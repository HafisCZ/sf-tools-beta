<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Simulator</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="res/favicon.png"/>

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>
        <script src="js/lang.js"></script>

        <script src="js/core/util.js"></script>
        <script src="js/core/playa.js"></script>
        <script src="js/core/core.js"></script>
        <script src="js/plugins.js"></script>
        <script src="js/changelog.js"></script>
        <script src="js/views.js"></script>
        <script src="js/sim/editor.js"></script>

        <script src="js/sim/base.js"></script>
        <script src="js/sim/players.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">

        <style>
            .bordered .fields:last-of-type {
                margin-bottom: 0;
            }

            .bordered {
                padding: 0.5em;
                margin-bottom: 0.5em;
            }

            .bordered-simple {
                margin-bottom: 0.35em;
                padding-top: 0.5em !important;
                padding-bottom: 0.5em !important;
                margin-right: 1em;
                margin-left: 1em;
            }

            .player-index {
                position: absolute;
                font-size: 90%;
                opacity: 50%;
                left: -0em;
                top: 1.5em;
            }

            .bnone {
                border: 1px solid transparent;
            }

            .bone {
                border: 1px solid orange;
            }

            .btwo {
                border: 1px solid purple;
            }

            .bthree {
                border: 1px solid blue;
            }

            .bfour {
                border: 1px solid red;
            }

            .bfive {
                border: 1px solid green;
            }

            .bsix {
                border: 1px solid pink;
            }

            .spaced {
                margin-top: 2em !important;
            }

            .sim-player-name-ihof {
                position: relative;
            }

            .sim-player-name span {
                display: none;
            }

            .sim-player-name-ihof b {
                position: absolute;
                left: 0;
                bottom: 0;
            }

            .sim-player-name-ihof span {
                position: absolute;
                left: 0;
                top: 0;
            }

            .selectable {
                -moz-user-select: -moz-none;
                -khtml-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                padding-bottom: 0.25em !important;
                padding-top: 0.25em !important;
            }

            .selectable div {
                padding: 0 !important;
            }

            .selectable-header div {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            .selected {
                background-color: rgba(0, 0, 0, 0.1);
                cursor: pointer;
            }

            .nselected {
                cursor: pointer;
            }

            [data-sort-style] {
                position: relative;
                margin-top: -15px;
                padding-top: 15px;
                margin-bottom: -15px;
                padding-bottom: 15px;
                margin-right: -10px;
                padding-right: 10px;
                margin-left: -10px;
                padding-left: 10px;
            }

            [data-sort-style="1"]::before {
                content: "\f0de";
                font-family: Icons;
                position: absolute;
                left: 1px;
                top: -3px;
                transform: scale(0.7);
            }

            [data-sort-style="2"]::before {
                content: "\f0dd";
                font-family: Icons;
                position: absolute;
                left: 1px;
                bottom: 0px;
                transform: scale(0.7);
            }

            .debug-container {
                position: absolute;
                top: 5em;
                left: 1em;
                font-size: 80%;
            }

            .class-picture {
                 margin-left: -0.75em !important;
                 margin-right: 0.5em !important;
            }

            .class-none {
                margin-left: 1.75em;
            }

            .css-smaller-pad > .column {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
        </style>
    </head>
    <body class="margin-none-bottom">
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item"><a class="css-a-blank" href="index.html">SFTools</a></div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i><span class="css-small">Go back</span></a>
            </div>
        </div>

        <div class="debug-container">
            <div class="debug">

            </div>
        </div>

        <div class="paste-target" onpaste="console.log">
            Click here and press <b>CTRL&nbsp;+&nbsp;V</b> to paste into the simulator
        </div>

        <div class="ui main container">
            <!-- Header -->
            <div class="ui five columns middle aligned grid">
                <div class="two wide column">

                </div>
                <div class="four wide column">

                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Fight Simulator</h1>
                </div>
                <div class="four wide column">

                </div>
                <div class="two wide wide column">

                </div>
            </div>
            <div class="ui two columns grid">
                <!-- Player edit field -->
                <div class="column">
                    <div class="ui form" id="sim-editor">

                    </div>
                </div>
                <!-- Player list -->
                <div class="column">
                    <div class="ui grid">
                        <div class="css-small-row row css-smaller-pad">
                            <div class="four wide column">
                                <button class="ui fluid small button" type="submit" id="sim-add"><i class="small arrow right icon"></i> Add</button>
                            </div>
                            <div class="four wide column">
                                <button class="ui fluid small button" type="submit" id="sim-save">Save</button>
                            </div>
                            <div class="two wide column">
                                <button class="ui small basic icon fluid button" data-position="bottom center" data-tooltip="DANGEROUS: Enable fight data dump" id="sim-debug"><i class="file code outline icon"></i></button>
                            </div>
                            <div class="two wide column">
                                <button class="ui tiny basic icon fluid button" data-position="bottom center" data-tooltip="Toggle Add/Replace insertion mode" id="sim-insert"><i class="paste icon"></i></button>
                            </div>
                            <div class="four wide column">
                                <div class="ui tiny basic icon fluid two buttons">
                                    <button class="ui button" data-position="bottom center" data-tooltip="Copy current" id="sim-copy"><i class="outline copy icon"></i> 1</button>
                                    <button class="ui button" data-position="bottom center" data-tooltip="Copy everyone" id="sim-copyall"><i class="copy icon"></i> All</button>
                                </div>
                            </div>
                        </div>
                        <div class="css-small-row row css-smaller-pad">
                            <div class="five wide column">
                                <div class="ui small form">
                                    <div class="two fields">
                                        <div class="field" data-position="bottom center" data-tooltip="Simulator threads. Keep this number BELOW your processor core count!">
                                            <input class="text-center fluid" type="text" id="sim-threads" value="4">
                                        </div>
                                        <div class="field" data-position="bottom center" data-tooltip="Amount of iterations per thread.">
                                            <input class="text-center fluid" type="text" id="sim-iterations" value="2500">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="four wide column">
                                <div class="ui small form">
                                    <div class="field">
                                        <div class="ui fluid selection compact dropdown" id="sim-mode">
                                            <div class="text"></div>
                                            <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="two wide column">
                                <button class="ui small basic icon fluid button" data-position="bottom center" data-tooltip="IHOF Mode: Gladiator is set to 15 and is not reduced!" id="sim-ihof">IHOF</button>
                            </div>
                            <div class="five wide column">
                                <button class="ui fluid small button" type="submit" id="sim-run">Simulate</button>
                            </div>
                        </div>
                        <div class="row clickable selectable-header">
                            <div class="two wide text-center column">
                                <span data-sort="class">
                                    Class
                                </span>
                            </div>
                            <div class="two wide column">
                                <span data-sort="level">
                                    Level
                                </span>
                            </div>
                            <div class="four wide column">
                                <span data-sort="name">
                                    Name
                                </span>
                            </div>
                            <div class="two wide text-center column">
                                <span data-sort="avg">
                                    Win %
                                </span>
                            </div>
                            <div class="two wide text-center column">
                                <span data-sort="min">
                                    Min %
                                </span>
                            </div>
                            <div class="two wide text-center column">
                                <span data-sort="max">
                                    Max %
                                </span>
                            </div>
                            <div class="one wide column">

                            </div>
                            <div class="one wide column">

                            </div>
                        </div>
                        <div class="row padding-none">
                            <div class="sixteen wide column">
                                <hr/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="sixteen wide column">
                                <div class="ui middle aligned grid" id="sim-players">

                                </div>
                            </div>
                        <div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            function toggleAll (dis) {
                if (dis) {
                    PopupController.open(LoaderPopup);
                } else {
                    PopupController.close(LoaderPopup);
                }
            }

            let editor = new Editor($('#sim-editor'));

            const UILogger = new (class {
                constructor ($root) {
                    this.$root = $root;
                }

                clear () {
                    this.$root.html('');
                }

                append (line) {
                    this.$root.append(`${ line }</br>`);
                }
            })($('.debug'));

            var selected = -1;
            var yourself = -1;

            var players = [];
            var iterator = 0;

            var modeIhof = false;
            $('#sim-ihof').click(function () {
                modeIhof = !modeIhof;
                if (modeIhof) {
                    this.style.setProperty('background', '#21ba45', 'important');
                } else {
                    this.style.setProperty('background', '');
                }
                $('.sim-player-name, .sim-player-name-ihof').toggleClass('sim-player-name').toggleClass('sim-player-name-ihof');
                showPlayers();
            });

            var modeDump = false;
            $('#sim-debug').click(function () {
                modeDump = !modeDump;
                if (modeDump) {
                    this.style.setProperty('background', '#eb8034', 'important');
                } else {
                    this.style.setProperty('background', '');
                }
            });

            var modeInsert = false;
            $('#sim-insert').click(function () {
                modeInsert = !modeInsert;
                if (modeInsert) {
                    this.style.setProperty('background', '#21ba45', 'important');
                } else {
                    this.style.setProperty('background', '');
                }
            });

            var mode = 0;
            $('#sim-mode').dropdown({
                values: [
                    {
                        name: 'All vs All',
                        value: 0
                    },
                    {
                        name: 'One vs All',
                        value: 1
                    },
                    {
                        name: 'Tournament',
                        value: 2
                    }
                ]
            }).dropdown('setting', 'onChange', (value, text) => {
                mode = Number(value);

                for (var p of players) {
                    p.score = null;
                }

                yourself = -1;
                clearSort();
            }).dropdown('set selected', '0')

            $('#sim-editor input').on('paste', function (event) {
                event.stopPropagation();
            });

            $(document.body).on('paste', function (event) {
                try {
                    insertExternalData(JSON.parse(event.originalEvent.clipboardData.getData('text')));
                } catch (e) {
                    console.info(e);
                }
            }).on('dragover dragenter', e => {
                e.preventDefault();
                e.stopPropagation();
            }).on('drop', e => {
                if (_dig(e, 'originalEvent', 'dataTransfer', 'files', 0, 'type') == 'text/plain') {
                    e.preventDefault();
                    e.stopPropagation();

                    try {
                        let r = new FileReader();
                        r.readAsText(e.originalEvent.dataTransfer.files[0], 'UTF-8');
                        r.onload = f => insertExternalData(JSON.parse(f.target.result));
                    } catch (ex) {
                        console.info(ex);
                    }
                }
            });

            function insertExternalData (data) {
                if (Array.isArray(data)) {
                    if (!modeInsert) {
                        players = [];
                    }

                    for (var d of data) {
                        if (d.Class) {
                            SFItem.forceCorrectRune(d.Items.Wpn1);
                            SFItem.forceCorrectRune(d.Items.Wpn2);

                            if (d.Class == 1 && typeof d.BlockChance == 'undefined') d.BlockChance = d.Items.Wpn2.DamageMin;
                            if (d.Class != 4) {
                                d.Items.Wpn2 = SFItem.empty();
                            }

                            players.push({
                                player: mergeSoft(new SFPlayer(), d),
                                score: null,
                                index: iterator++
                            });
                        } else {
                            var obj = d.own ? new SFOwnPlayer(d) : new SFOtherPlayer(d);

                            SFItem.forceCorrectRune(obj.Items.Wpn1);
                            SFItem.forceCorrectRune(obj.Items.Wpn2);

                            if (obj.Class == 1 && typeof obj.BlockChance == 'undefined') obj.BlockChance = obj.Items.Wpn2.DamageMin;
                            if (obj.Class != 4) {
                                obj.Items.Wpn2 = SFItem.empty();
                            }

                            players.push({
                                player: mergeSoft(new SFPlayer(), obj),
                                score: null,
                                index: iterator++
                            });
                        }
                    }

                    showPlayers();
                } else if (data.Class || data.save) {
                    var obj = data.Class ? data : (data.own ? new SFOwnPlayer(data) : new SFOtherPlayer(data));

                    SFItem.forceCorrectRune(obj.Items.Wpn1);
                    SFItem.forceCorrectRune(obj.Items.Wpn2);

                    if (obj.Class == 1 && typeof obj.BlockChance == 'undefined') obj.BlockChance = obj.Items.Wpn2.DamageMin;
                    if (obj.Class != 4) {
                        obj.Items.Wpn2 = SFItem.empty();
                    }

                    editor.fill(obj);
                }
            }

            $('#sim-threads').captiveInputField('player_sim/threads', 4, v => !isNaN(v) && v >= 1);
            $('#sim-iterations').captiveInputField('player_sim/iterations', 2500, v => !isNaN(v) && v >= 1);

            // Run simulation
            $('#sim-run').click(async function () {
                if (players.length > 1 && (mode != 1 || (mode == 1 && players.find(p => p.index == yourself)))) {
                    UILogger.clear();

                    for (var i = 0; i < players.length; i++) {
                        players[i].score = null;
                        if (modeIhof) {
                            players[i].player.ForceGladiator = 15;
                        }
                    }

                    showPlayers();
                    toggleAll(true);

                    let blocks = Math.max(1, Number($('#sim-threads').val()) || 4);
                    let blockSize = Math.ceil(players.length / blocks);
                    let iterations = Math.max(1, Number($('#sim-iterations').val()) || 2500);

                    var results = [];
                    var ladder = [];
                    var logs = [];

                    if (mode == 2) {
                        UILogger.append(`GENERATING LADDER`);

                        ladder = [ ... players ];
                        new FightSimulator().simulateMultiple(ladder, ladder, 100);

                        ladder.sort((a, b) => a.score.avg - b.score.avg);

                        for (var i = 0; i < ladder.length; i++) {
                            ladder[i].score = null;
                        }
                    }

                    UILogger.append(`BLOCK SIZE: <b>${ blockSize }</b>`);
                    UILogger.append(`ITERATIONS: <b><b>${ iterations }</b>`);
                    UILogger.append(`<b><br/>STARTING ${ blocks } THREADS</b>`);

                    for (var i = 0; i < players.length; i += blockSize) {
                        var block = players.slice(i, i + blockSize);
                        var worker = await createSimulatorWorker('players');

                        worker.addEventListener('message', function (message) {
                            if (message.data.command == 'finished') {
                                results.push(... message.data.results);

                                if (modeDump) {
                                    logs.push(... message.data.logs);
                                }

                                UILogger.append(`THREAD FINISHED IN <b>${ message.data.time / 1000 }</b> SECONDS`);

                                if (results.length == players.length) {
                                    toggleAll();

                                    players = results;
                                    setSort('avg', 0);

                                    if (modeDump) {
                                        download('logs.json', new Blob([ JSON.stringify(logs) ], {
                                            type: 'application/json'
                                        }));
                                    }
                                }
                            }
                        }, false);

                        if (mode == 0) {
                            worker.postMessage({
                                mode: 'players_all',
                                player: block,
                                players: players,
                                iterations: iterations,
                                dev: modeDump
                            });
                        } else if (mode == 1) {
                            worker.postMessage({
                                mode: 'players_one',
                                player: players.find(p => p.index == yourself),
                                players: block,
                                iterations: iterations,
                                dev: modeDump
                            });
                        } else if (mode == 2) {
                            worker.postMessage({
                                mode: 'players_tournament',
                                player: block,
                                players: ladder,
                                iterations: iterations,
                                dev: modeDump
                            });
                        }
                    }
                }
            });

            $('#sim-save').click(function () {
                if (editor.valid()) {
                    if (selected != -1) {
                        var index = players.findIndex(p => p.index == selected);
                        if (index != -1) {
                            players[index].player = editor.read();
                            players[index].score = null;
                        }

                        showPlayers();
                    } else {
                        $('#sim-add').trigger('click');
                    }
                }
            });

            $('#sim-copy').click(function () {
                copyText(JSON.stringify(editor.read()));
            });

            $('#sim-copyall').click(function () {
                copyText(JSON.stringify(players.map(p => {
                    let m = toSimulatorModel(p.player);
                    if (p.player.Class == 1 && typeof p.player.BlockChance != 'undefined') {
                        m.BlockChance = p.player.BlockChance;
                    }

                    return m;
                })));
            });

            $('#sim-add').click(function () {
                if (editor.valid()) {
                    var player = editor.read();
                    if (player.Name == '') {
                        player.Name = `Player ${ players.length + 1 }`;
                    }

                    selected = iterator++;
                    players.push({
                        player: player,
                        score: null,
                        index: selected
                    });

                    editor.clear();

                    showPlayers();
                }
            });

            var sort = '';
            var order = 0;

            $('[data-sort]').click(function () {
                setSort($(this).attr('data-sort'));
            });

            function setSort (key, ord) {
                if (ord == undefined) {
                    if (sort == key) {
                        order = (order + 1) % 2;
                    } else {
                        sort = key;
                        order = 0;
                    }
                } else {
                    sort = key;
                    order = ord;
                }

                showPlayers();
            }

            function clearSort () {
                sort = '';
                order = 0;

                showPlayers();
            }

            function showPlayers () {
                if (order == 0) {
                    if (sort == 'class') {
                        players.sort((a, b) => a.player.Class - b.player.Class);
                    } else if (sort == 'level') {
                        players.sort((a, b) => b.player.Level - a.player.Level);
                    } else if (sort == 'name') {
                        players.sort((a, b) => a.player.Name.localeCompare(b.player.Name));
                    } else if (sort == 'avg') {
                        players.sort((a, b) => b.score && a.score && (b.score.avg - a.score.avg));
                    } else if (sort == 'min') {
                        players.sort((a, b) => b.score && a.score && (b.score.min - a.score.min));
                    } else if (sort == 'max') {
                        players.sort((a, b) => b.score && a.score && (b.score.max - a.score.max));
                    }
                } else {
                    if (sort == 'class') {
                        players.sort((b, a) => a.player.Class - b.player.Class);
                    } else if (sort == 'level') {
                        players.sort((b, a) => b.player.Level - a.player.Level);
                    } else if (sort == 'name') {
                        players.sort((b, a) => a.player.Name.localeCompare(b.player.Name));
                    } else if (sort == 'avg') {
                        players.sort((b, a) => b.score && a.score && (b.score.avg - a.score.avg));
                    } else if (sort == 'min') {
                        players.sort((b, a) => b.score && a.score && (b.score.min - a.score.min));
                    } else if (sort == 'max') {
                        players.sort((b, a) => b.score && a.score && (b.score.max - a.score.max));
                    }
                }

                $('[data-sort]').each(function () {
                    $(this).attr('data-sort-style', $(this).attr('data-sort') == sort ? (order + 1) : 0);
                });

                var content = '';

                if (mode == 1 && yourself == -1) {
                    if (players.length) {
                        yourself = players[0].index;
                    }
                }

                if (mode > 0) {
                    $('[data-sort="min"]').hide();
                    if (mode == 1) {
                        $('[data-sort="max"]').hide();
                    } else {
                        $('[data-sort="max"]').show();
                    }
                } else {
                    $('[data-sort="min"]').show();
                    $('[data-sort="max"]').show();
                }

                if (mode == 2) {
                    $('[data-sort="max"]').text('Ladder');
                } else {
                    $('[data-sort="max"]').text('Max %');
                }

                for (var i = 0; i < players.length; i++) {
                    var player = players[i].player;
                    var score = players[i].score;
                    var index = players[i].index;

                    content += `
                        <div class="row selectable ${ index == selected ? 'selected' : 'nselected' } ${ mode == 1 && index == yourself ? 'btwo' : 'bnone' }" data-index="${ index }">
                            <div class="player-index">${ i + 1 }</div>
                            <div class="two wide text-center column">
                                <img class="ui medium centered image" style="width: 50px;" src="res/class${ player.Class }.png">
                                ${ player.Class == 8 && player.Mask > 0 ? `<img class="ui image" src="res/mask${ player.Mask }.png" style="position: absolute; right: 0.75em; bottom: 0.1em; width: 1.55em; height: 1.55em;">` : '' }
                                ${ player.Class == 9 ? `<img class="ui image" src="res/instrument${ player.Instrument }.png" style="position: absolute; right: 0.75em; bottom: 0.1em; width: 1.55em; height: 1.55em;">` : '' }
                            </div>
                            <div class="one wide text-center column">
                                <b>${ player.Level }</b>
                            </div>
                            <div class="one wide column"></div>
                            <div class="four wide column sim-player-name${ modeIhof && player.Prefix ? '-ihof' : '' }">
                                <b>${ player.Name }</b>
                                <span>${ player.Prefix }</span>
                            </div>
                            <div class="two wide text-center column">
                                ${ score ? (mode == 2 ? `${ score.avg } pt` : (mode == 1 && index == yourself ? '' : `${ score.avg.toFixed(2) }%`)) : '' }
                            </div>
                            <div class="two wide text-center column">
                                ${ score && score.min != undefined ? `${ score.min.toFixed(2) }%` : '' }
                            </div>
                            <div class="two wide text-center column">
                                ${ score && score.max != undefined ? (mode == 2 ? `${ score.max }` : `${ score.max.toFixed(2) }%`) : '' }
                            </div>
                            <div class="one wide text-center column">
                                ${ mode == 1 && index != yourself ? `<i class="user circle icon glow-y" data-index-crown="${ i }"></i>` : ''}
                            </div>
                            <div class="one wide text-center column">
                                <i class="trash right aligned alternate glow outline icon" data-index-trash="${ i }"></i>
                            </div>
                        </div>
                    `;
                }

                $('#sim-players').html(content);

                $('[data-index]').click(function () {
                    selected = Number($(this).attr('data-index'));
                    editor.fill(players.find(p => p.index == selected).player);

                    showPlayers();
                });

                $('[data-index-crown]').click(function () {
                    yourself = players[Number($(this).attr('data-index-crown'))].index;

                    showPlayers();
                });

                $('[data-index-trash]').click(function () {
                    var sel = Number($(this).attr('data-index-trash'));
                    players.splice(sel, 1);

                    var ss = players.findIndex(p => p.index == selected);
                    if (ss == -1) {
                        editor.clear();
                    }

                    selected = ss;

                    var sx = players.findIndex(p => p.index == yourself);
                    if (sx == -1) {
                        yourself = -1;
                    }

                    showPlayers();
                });
            }
        </script>
    </body>
</html>
